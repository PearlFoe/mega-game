{% extends 'base.html' %}

{% load static %}

{% block styles %}
	<link rel="stylesheet"
		href="{% static 'articles/all_articles.css' %}">
{% endblock %}

{% block javascript %}
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script>
	function getNewArticles(){
	var article_id = document.evaluate('//div[@class="articles"]/div[1]/@id', document.body, null, XPathResult.STRING_TYPE, null).stringValue;
	var url = "{% url 'get_new_articles_url' event.id %}"+article_id
	$.get(url, function(data) {
		if(data.articles != 'undefined'){
			for(article in data.articles){
				//здесь бы собирать html и обновлять сраницу
				// полезная ссылка https://proweb63.ru/help/js/ajax-js-content
			}
		}
		setTimeout(getNewArticles, 10000); // 10000 miliseconds = 10 seconds
	});
	function setNewEntry(entry) {
        $('//div.articles').html(getNewEntry($('//div.articles').html(), entry));
    }
    function getNewEntry(oldHTML, newHTML) {
        if(newHTML == '') 
            return newHTML;
        else
            return oldHTML + newHTML;
    }
	}
	function on_subm(){
		$.ajax({
			data: $('form').serialize(),
			type: "POST",
			url: "{% url 'create_new_article_url' event.id %}",
			success: getNewArticles(),
			error: function (response) {
				alert("Что-то пошло не так(");
				console.log(response.responseJSON.errors)
			}
		});
		return false;
	}
	window.onload = getNewArticles;
  </script>
{% endblock javascript %}

{% block content %}
	<div class="articles">
		{% for article in articles %}
			<div class="card border-dark mb-3" id="{{ article.id }}">
				<div class="card-body">
					<h5 class="card-title">{{ article.title }}</h5>
					{% if article.description %}
						<p class="card-text">{{ article.description }}</p>
					{% endif %}
				</div>
				<div class="card-footer text-white bg-dark bg-opacity-75">
					<p class="card-text"><b>{{ article.created_by }}</b></p>
				</div>
			</div>
		{% endfor %}
	</div>
	<div class="article-form bg-dark">
		<form method="post" id="create-article">
			{% csrf_token %}
			{{ form }}
			<input type="button" class="btn btn-primary" value="Submit" onclick="return on_subm();">
		</form>
	</div>
{% endblock %}
